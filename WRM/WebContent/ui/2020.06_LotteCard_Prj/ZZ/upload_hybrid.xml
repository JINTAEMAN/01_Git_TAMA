<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    		<!-- 
	       ###################################################
	        파일명 : upload_hybrid.xml
	        프로그램명 : Hybird 파일 업로드 화면
	        설 명 :   
	        작성자 : 진태만
	        작성일 : 2020.06.26
	
	        수정일자            수정자                  수정내용
	       ==================================================
	       2020.06.26       진태만     				 최초작성
	       ###################################################
	    -->
    <head>
    	<w2:type>DEFAULT</w2:type>
        <w2:buildDate/>
        <xf:model>
            <xf:instance>
                <data xmlns=""/>
            </xf:instance>
            <w2:dataCollection baseNode="map">
            </w2:dataCollection>
            <w2:workflowCollection>
            </w2:workflowCollection>
        </xf:model>
         <script type="text/javascript" lazy="false"><![CDATA[
//	       ###################################################
//	        파일명 : upload_hybrid.xml
//	        프로그램명 : Hybird 파일 업로드 화면
//	        설 명 :   
//	        작성자 : 진태만
//	        작성일 : 2020.06.26
//	
//	        수정일자            수정자                  수정내용
//	       ==================================================
//	       2020.06.26       진태만     				 최초작성
//	       ###################################################
 
	var pageSize = "10";		//  페이지수(총 조회 수)
	var pageCount = "10";		//  보여지는 페이지수[총 8 Page]
	var sToday = ""; 
	var bAuthFlag = false;		//전역변수
	var slevel = "";
	var medt_Str_Event;	// medt_Str(InputBox) MaskEdit 정규식 입력

	/**
	 * 초기 스크립트 수행 함수 정의
	 */
	scwin.onpageload = function() {
		console.log("[/upload_hybrid.xml] [onpageload()] ==> [TEST_01] [Hybird 파일 업로드 화면 로딩...@@@]" );
		alert("[/upload_hybrid.xml] [onpageload()] ==> [폼 로딩] [TEST_01]" );
		
		// 인앱업데이트 스크린 제거.
        $h.inappupdate.dismissScreen();
	};
  	
	/**
	 * Hybrid 파일 선택
	 */
	scwin.trigger1_onclick = function(e) {
		console.log("[/upload_hybrid.xml] [trigger1_onclick()] ==> [TEST_01] [Hybird 파일선택]" );
        aler("[/upload_hybrid.xml] [trigger1_onclick()] ==> [TEST_01] [Hybird 파일 선택]" ); 
   
        var opt = {};
        opt.multiselect = true;
        opt.extension = "xlsx,docx,pptx,jpg,png,pdf,txt,mp4"; // 디바이스 파일탐색기에서 보여줄 확장자 
        opt.start = "" //default : document
        opt.maxcount = 2;
            
        $h.contents.filePicker(scwin.filePickerSuccess, scwin.filePickerFail, opt); 	  // 파일 선택창을 띄움(Hybird API)
	};
	
	/**
	 * 파일 선택 성공 콜백
	 */
    scwin.filePickerSuccess = function(result) {
        //console.log("하이브리드 파일 선택 성공: ", result); // local storage path 
        aler("[/upload_hybrid.xml] [filePickerSuccess()] ==> [TEST_01] [Hybird 파일선택 성공 콜백]" ); 
        
        scwin.filePath = "file://"+result[0];
        
        ibx_fileNm.setValue(scwin.filePath.substr(scwin.filePath.lastIndexOf("/")+1, scwin.filePath.length));
        
        scwin.fn_fileUpload();		// Hybird 파일 업로드 처리
    };
    
    // 파일 선택 실패 콜백 
    scwin.filePickerFail = function(e){ 
        console.error("filePickerFail: ", e); 
    };
    
	/**
	 * Hybird 파일 업로드 처리
	 */
	scwin.fn_fileUpload = function(e) { 
        console.log("[/upload_hybrid.xml] [fn_fileUpload()] ==> [TEST_01] [Hybird 파일 업로드 처리]" );
        aler("[/upload_hybrid.xml] [fn_fileUpload()] ==> [TEST_01] [Hybird 파일 업로드 처리]" );
        
        //var url = "http://172.30.1.43:3131/websquare/upload.wq" // upload 모듈 url
        var url = "http://localhost/JSP/FileUpload.jsp";			// upload 모듈 url(http 필수)
        var filePath = scwin.filePath;		// 파일 경로         
        var ext = filePath.substr(filePath.lastIndexOf(".")+1, filePath.length);	 	// 확장자 확인
        
        var contType = "";	 // 확장자에 따라 contentType 지정 
        
        switch(ext) {
            case "doc": contType = "application/msword"; break;
            case "docx": contType = "application/vnd.openxmlformats-officedocument.wordprocessingml.document"; break;
            case "xls": contType = "application/vnd.ms-excel"; break;
            case "xlsx": contType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"; break;
            case "ppt": contType = "application/vnd.ms-powerpoint"; break;
            case "pptx": contType = "application/vnd.openxmlformats-officedocument.presentationml.presentation"; break;
            case "gif": contType = "image/gif"; break;
            case "jpg": contType = "image/jpg"; break;
            case "jpeg": contType = "image/jpeg"; break;
            case "png": contType = "image/png"; break;
            case "pdf": contType = "application/pdf"; break;
        }
        
        // 하이브리드 업로드 옵션
        var opt = {
            "url": url,
            "path": filePath,
            "contentType":contType
        };
        aler("[/upload_hybrid.xml] [fn_fileUpload()] ==> [TEST_41] [Hybird 파일 업로드 시작_전 @@@@] [URL]"+ url +"[파일 경로]"+ filePath +"[파일 타입]"+ contType );
                
        $h.file.uploadFile(function(xhr) { 
            //aler("[/upload_hybrid.xml] [fn_fileUpload()] ==> [TEST_51] [Hybird 파일 업로드 시작_결과] [xhr]"+ xhr +"[상태]"+ xhr.readyState );
            
            if(xhr.readyState==4 && xhr.status==200) 
            { 
               	aler("[/upload_hybrid.xml] [fn_fileUpload()] ==> [업로드 성공!!!!]" );
               	
                var result = xhr.responseText;
                scwin.callback(result.substring(result.indexOf("<ret>"), result.indexOf("</ret>") + 6));
               	aler("[/upload_hybrid.xml] [fn_fileUpload()] ==> [TEST_71] [Hybird 파일 업로드 시작_결과] [xhr]"+ xhr +"[상태]"+ xhr.readyState ); 
                //ibx_fileNm.setValue("");
            }
        }, function(err) {
            // console.error("err: ", err);
        }, opt);
        //console.log("업로드 끝: ");
	};
 	
	/**
	 * Hybrid 파일 업로드 콜백 처리
	 */
	scwin.callback = function(doneRet) {  
		 aler("[/upload_hybrid.xml] [callback()] ==> [TEST_01] [Hybrid 파일 업로드 콜백 처리]" );
 		
		 var storedFileList = doneRet.subsring(doneRet.indexOf("<storedFileList>")+16, doneRet.indexOf("</storedFileList>"));		// 업로드 파일명
		 var localfileList = doneRet.subsring(doneRet.indexOf("<localfileList>")+14, doneRet.indexOf("</localfileList>"));		// 원본 파일명
		 var fileExt = doneRet.subsring(doneRet.indexOf("<fileExt>")+9, doneRet.indexOf("</fileExt>"));		// 파일 확장자명
		 var fileSizeList = doneRet.subsring(doneRet.indexOf("<fileSizeList>")+14, doneRet.indexOf("</fileSizeList>"));		// 파일 크기
  
		var idx = dlt_fileList.insertRow();   // 파일 정보 Ds 줄 추가
		
		dlt_fileList.setCellData(0 , "isNew" , 'Y' );		// 신규 여부
		dlt_fileList.setCellData( 0 , "AN_FILE_ID" , storedFileList );	// 업로드된 파일명
		dlt_fileList.setCellData( 0 , "AN_FILE_ORG" , localfileList );		// 원본 파일명
		dlt_fileList.setCellData( 0 , "AN_FILE_EXG" , fileExt );				// 파일 확장자명
		dlt_fileList.setCellData( 0 , "AN_FILE_SIZE" , fileSizeList );		// 파일 크기
		console.log("[/upload_hybrid.xml] [callback()] ==> [TEST_52] [dlt_fileList]"+ WebSquare.xml.serialize(dlt_fileList.getAllXML()) );
	};
	
	/**
	 * 파일 다운로드
	 */ 
	scwin.btn_download_onclick = function() {
		
		var sUloadFileNm = dlt_getCellData(0, 'A AN_FILE_ID');  	// 업로드된 파일명
		
		var url = 'http://lottr.com/fileUpload/up/'+ sUloadFileNm;  	// Download 모듈 URL
		// 실제 URL ==> http://lottr.com/fileUpload/up/202006300000.xlsx
 
		var opt = {
				"url": url,
				"progress": true, 
				"open": true, 
				"notify": true
			};
	 
		$h.contents.fileDonwload(scwin.fileDownloadSucces, scwin.fileDownloadFail, opt);  	// 파일 다운로드 (Hybird API)
	};	
	
	/**
	 * 파일 다운로드 성공 콜백
	 */
    scwin.fileDownloadSucces = function(result) {  
        console.error("fileDownloadSucces: ", result); 
        //aler("[/upload_hybrid.xml] [fileDownloadSucces()] ==> [TEST_01] [Hybird 파일선택 성공 콜백]" );  
    };
	    
	    // 파일 다운로드 실패 콜백 
    /**
	 * 파일 다운로드 실패 콜백 
	 */
    scwin.fileDownloadFail = function(e) { 
    };
  	
	/* ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
	+------------------------------------------------// script 종료 //------------------------------------------------------------+
	■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■ */
	]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload" ev:onpageunload="scwin.onpageunload">
        <xf:trigger type="button" id="trigger1" style="position: relative;width: 80px;height: 23px;margin-left:0px;"  ev:onclick="scwin.trigger1_onclick">
            <xf:label><![CDATA[파일 선택]]></xf:label>
        </xf:trigger>
<!--        <xf:trigger type="button" id="trigger2" style="position: relative;width: 80px;height: 23px;" ev:onclick="scwin.trigger2_onclick">-->
<!--            <xf:label><![CDATA[업로드 ]]></xf:label>-->
<!--        </xf:trigger>-->
        <xf:input adjustMaxLength="false" id="ibx_fileNm" style="position: relative;width: 144px;height: 21px;" readOnly="true"></xf:input>
    </body>
</html>
